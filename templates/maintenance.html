<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Maintenance</title>
<link rel="icon" type="image/svg+xml" href="https://static.wikia.nocookie.net/logopedia/images/e/e3/Minecraft_Launcher.svg/revision/latest/scale-to-width-down/250?cb=20230616222246">
<link rel="stylesheet" href="{{ url_for('static', filename='nav.css', v=static_version('nav.css')) }}">
<link rel="stylesheet" href="{{ url_for('static', filename='files.css', v=static_version('files.css')) }}">
<link rel="stylesheet" href="{{ url_for('static', filename='global.css', v=static_version('global.css')) }}">
<link rel="stylesheet" href="{{ url_for('static', filename='maintenance.css', v=static_version('maintenance.css')) }}">
</head>
<body data-page="maintenance">
<div class="layout">
    {% include "partials/nav.html" %}
    <main class="content">
        <div class="wrap maintenance-wrap">
            <section class="panel maintenance-panel pane-primary maintenance-top-header">
                <div class="maintenance-title-wrap title">
                    <div class="maintenance-title-row title-row">
                        <h1>Maintenance</h1>
                        <div class="maintenance-header-actions">
                            <div class="maintenance-scope-toggle" role="group" aria-label="Cleanup scope">
                                <button id="maint-scope-backups" class="nav-link maintenance-header-btn" type="button">Backups</button>
                                <button id="maint-scope-stale" class="nav-link maintenance-header-btn" type="button">Stale Worlds</button>
                            </div>
                            <span class="maintenance-header-divider" aria-hidden="true"></span>
                            <button id="maint-open-rules" class="nav-link maintenance-header-btn" type="button">Cleanup Rules</button>
                            <button id="maint-open-history" class="nav-link maintenance-header-btn" type="button">Cleanup History</button>
                            <button id="maint-open-manual" class="nav-link maintenance-header-btn" type="button">Manual Cleanup</button>
                        </div>
                    </div>
                    <div class="maintenance-stats">
                        <div class="stats-group">
                            <p class="group-title">Server Stats</p>
                            <div class="status-row">
                                <span>Storage remaining: <strong id="maint-storage-remaining">-</strong></span>
                                <span>Backups: <strong id="maint-backup-summary">-</strong></span>
                                <span>Stale worlds: <strong id="maint-stale-summary">-</strong></span>
                            </div>
                        </div>
                        <div class="stats-group">
                            <p class="group-title">History &amp; Audit</p>
                            <div class="status-row">
                                <span>Last run: <strong id="history-last-run">-</strong></span>
                                <span>Rule version: <strong id="history-rule-version">-</strong></span>
                                <span>Schedule version: <strong id="history-schedule-version">-</strong></span>
                                <span>Last changed by: <strong id="history-last-changed-by">-</strong></span>
                                <span>Missed runs: <strong id="history-missed-runs">0</strong></span>
                            </div>
                        </div>
                        <div class="stats-group">
                            <p class="group-title">Rules &amp; Schedule Stats</p>
                            <div class="status-row">
                                <span>Schedules: <strong id="maint-schedule-count">0</strong></span>
                                <span>Active rules: <strong id="maint-rule-count">0</strong></span>
                                <span>Next run: <strong id="maint-next-run">-</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="panel maintenance-panel pane-primary maintenance-left-pane">
                <div class="maintenance-pane-head">
                    <h2>File and Cleanup Eligibility List</h2>
                </div>
                <div class="maintenance-left-content">
                    <div class="maintenance-file-list">
                        <ul id="cleanup-file-list" class="list"></ul>
                    </div>
                </div>
            </section>

            <section id="maintenance-action-pane" class="panel maintenance-panel pane-primary maintenance-right-pane">
                <input id="maintenance-csrf-token" type="hidden" value="{{ csrf_token }}">
                <div id="maintenance-bootstrap-data" data-config='{{ maintenance_snapshot.config|tojson|safe }}' data-preview='{{ maintenance_preview|tojson|safe }}' data-non-normal='{{ maintenance_snapshot.non_normal|tojson|safe }}' data-storage='{{ maintenance_snapshot.storage|tojson|safe }}' data-history='{{ maintenance_snapshot.history|tojson|safe }}' data-next-run='{{ maintenance_snapshot.next_run_at|tojson|safe }}' data-scope='{{ maintenance_scope|tojson|safe }}' data-device-map='{{ maintenance_device_map|tojson|safe }}' hidden></div>

                <div class="maintenance-pane-head">
                    <div class="maintenance-pane-title-row">
                        <h2 id="maintenance-action-title">Cleanup Rules</h2>
                    </div>
                    <div class="maintenance-pane-head-actions">
                        <button id="rules-save-btn" class="btn-backup" type="button" hidden>Save</button>
                        <button id="rules-edit-toggle-btn" class="btn-backup" type="button" hidden>Edit</button>
                    </div>
                </div>

                <div class="maintenance-action-content">
                    <div id="maintenance-action-toolbar" class="maintenance-action-toolbar">
                        <p id="maintenance-action-description" class="maintenance-meta"></p>
                    </div>

                    <div id="maintenance-view-rules" class="maintenance-action-view">
                        <div id="rules-card-list" class="maintenance-card-list"></div>
                        <div id="rules-run-panel" class="maintenance-card rule-run-panel">
                            <label class="maintenance-check"><input id="rule-run-dry-run" type="checkbox" checked> Dry run (no files are deleted)</label>
                            <label id="rule-run-destructive-confirm-wrap" class="maintenance-check" hidden><input id="rule-run-destructive-confirm" type="checkbox"> This action is destructive and cannot be undone. Please confirm.</label>
                            <button id="run-rule-delete-btn" class="btn-start" type="button">Run Rule-Based Delete Now</button>
                        </div>
                    </div>

                    <div id="maintenance-view-manual" class="maintenance-action-view" hidden>
                        <div class="maintenance-card">
                            <div class="maintenance-form">
                                <p class="maintenance-meta">Delete selected eligible files from the left pane.</p>
                                <label class="maintenance-check"><input id="manual-dry-run" type="checkbox" checked> Dry run (no files are deleted)</label>
                                <label id="manual-destructive-confirm-wrap" class="maintenance-check" hidden><input id="manual-destructive-confirm" type="checkbox"> This action is destructive and cannot be undone. Please confirm.</label>
                                <button id="run-manual-delete-btn" class="btn-start" type="button">Confirm Manual Cleanup</button>
                            </div>
                        </div>
                    </div>

                    <div id="maintenance-view-history" class="maintenance-action-view" hidden>
                        <div class="maintenance-group">
                            <div class="maintenance-form">
                                <div id="history-card-list" class="maintenance-card-list"></div>
                                <button id="ack-non-normal-btn" class="btn-stop" type="button">Acknowledge Missed Run</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<div id="maintenance-password-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="maintenance-password-title">
        <h3 id="maintenance-password-title" class="modal-title">Password Required</h3>
        <p id="maintenance-password-text" class="modal-text">Enter sudo password to continue.</p>
        <input id="maintenance-password-input" class="modal-input ui-text-input" type="password" autocomplete="current-password" placeholder="Sudo password">
        <div class="modal-actions">
            <button id="maintenance-password-cancel" class="btn-backup" type="button">Cancel</button>
            <button id="maintenance-password-submit" class="btn-stop" type="button">Continue</button>
        </div>
    </div>
</div>

<div id="maintenance-error-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="maintenance-error-title">
        <h3 id="maintenance-error-title" class="modal-title">Maintenance Action Failed</h3>
        <p id="maintenance-error-text" class="modal-text"></p>
        <pre id="maintenance-error-details" class="modal-details"></pre>
        <div class="modal-actions">
            <button id="maintenance-error-ok" class="btn-backup" type="button">OK</button>
        </div>
    </div>
</div>

<div id="maintenance-dry-run-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="maintenance-dry-run-title">
        <h3 id="maintenance-dry-run-title" class="modal-title">Dry Run Results</h3>
        <p id="maintenance-dry-run-summary" class="modal-text"></p>
        <h4 class="modal-subtitle">Files That Would Be Deleted</h4>
        <ul id="maintenance-dry-run-files" class="modal-list"></ul>
        <h4 class="modal-subtitle">Errors / Issues</h4>
        <ul id="maintenance-dry-run-issues" class="modal-list"></ul>
        <div class="modal-actions">
            <button id="maintenance-dry-run-ok" class="btn-backup" type="button">OK</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='custom_select.js', v=static_version('custom_select.js')) }}"></script>
<script src="{{ url_for('static', filename='maintenance_bootstrap.js', v=static_version('maintenance_bootstrap.js')) }}"></script>
<script src="{{ url_for('static', filename='maintenance.js', v=static_version('maintenance.js')) }}"></script>
</body>
</html>
